# Логика работы и бизнес-правила

## 1. Типовые сценарии

### Сценарий А: Обработка новой сделки (Action Mode)
1. **Вход:** Получен объект сделки от API.
2. **Фильтр шума:** Если сумма < $50 -> игнор.
3. **Анализ кита:** Запрос истории, расчет Score.
4. **Pre-Flight Check:**
   - Запрос текущей цены через CLOB API.
   - Если `CurrentPrice > WhalePrice * 1.05` -> Отмена (Slippage Protection).
5. **Исполнение:**
   - Списание средств с `locked_funds`.
   - Создание записи в `positions`.
   - Отправка уведомления в Telegram.

### Сценарий Б: Закрытие рынка (Resolution)
1. **Триггер:** Таймер (каждые 5 мин).
2. **Выборка:** Все позиции со статусом `OPEN`.
3. **Проверка:** Запрос к CLOB API по `condition_id`.
4. **Условие:** Рынок закрыт (`resolved: true`)?
   - **Да:**
     - Определение победителя.
     - Расчет Payout: `Shares * ExitPrice`.
     - Обновление баланса пользователя.
     - Отправка уведомления (WIN/LOSS).

## 2. Бизнес-правила

### 2.1. Управление капиталом (Money Management)
- **Фиксированная ставка:** $1.00 (для теста).
- **Максимальная просадка:** Не ограничена (пока баланс > 0).
- **Сброс:** Команда `/reset` возвращает баланс к $20.

### 2.2. Защитные механизмы
1. **Slippage Protection:** Не входить, если цена ушла более чем на 5%.
2. **Copy Sell:** Если кит продает, мы тоже продаем (реализовано через мониторинг сделок кита).
3. **Tilt Breaker:** Если у кита 3 лосса подряд, его Score обнуляется.

### 2.3. Принцип "Честной Математики"
- **Wilson Score:** Используется для оценки винрейта кита.
- **Median PnL:** Используется для отсева "удачливых дураков" (тех, кто выиграл 1 раз на лаке).

## 3. Обработка ошибок
- **API Error:** Если Polymarket API недоступен, бот пропускает цикл и пишет лог.
- **DB Error:** Критические ошибки БД останавливают бота (через Self-Test).
- **Telegram Error:** Если пользователь заблокировал бота, уведомления отключаются, но портфель продолжает работать.
